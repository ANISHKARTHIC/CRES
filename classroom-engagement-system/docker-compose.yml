services:
  mongodb:
    image: mongo:6.0
    container_name: classroom-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: rootpassword
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - classroom-network

  redis:
    image: redis:7-alpine
    container_name: classroom-redis
    ports:
      - "6379:6379"
    networks:
      - classroom-network

  fastapi:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: classroom-fastapi
    environment:
      MONGODB_URL: mongodb://root:rootpassword@mongodb:27017/classroom?authSource=admin
      REDIS_URL: redis://redis:6379
      CELERY_BROKER_URL: redis://redis:6379
      CELERY_RESULT_BACKEND: redis://redis:6379
    ports:
      - "8000:8000"
    depends_on:
      - mongodb
      - redis
    volumes:
      - ./backend:/app
      - ./uploads:/app/uploads
    networks:
      - classroom-network

  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: classroom-celery
    command: celery -A app.tasks.celery_app worker --loglevel=info
    environment:
      MONGODB_URL: mongodb://root:rootpassword@mongodb:27017/classroom?authSource=admin
      REDIS_URL: redis://redis:6379
      CELERY_BROKER_URL: redis://redis:6379
      CELERY_RESULT_BACKEND: redis://redis:6379
    depends_on:
      - mongodb
      - redis
    volumes:
      - ./backend:/app
      - ./uploads:/app/uploads
    networks:
      - classroom-network

  react:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: classroom-react
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: http://fastapi:8000
    depends_on:
      - fastapi
    networks:
      - classroom-network

volumes:
  mongodb_data:

networks:
  classroom-network:
    driver: bridge
